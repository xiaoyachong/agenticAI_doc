<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Flow Diagrams</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 40px;
        }
        h2 {
            color: #34495e;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        .diagram-container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .flow-diagram {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .flow-step {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .component {
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 500;
            min-width: 180px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .agent {
            background: #3498db;
            color: white;
        }
        .framework {
            background: #2ecc71;
            color: white;
        }
        .registry {
            background: #e74c3c;
            color: white;
        }
        .user {
            background: #9b59b6;
            color: white;
        }
        .orchestrator {
            background: #f39c12;
            color: white;
        }
        .capability {
            background: #1abc9c;
            color: white;
        }
        .arrow {
            flex: 1;
            display: flex;
            align-items: center;
            position: relative;
        }
        .arrow-line {
            width: 100%;
            height: 2px;
            background: #34495e;
            position: relative;
        }
        .arrow-line::after {
            content: '‚ñ∂';
            position: absolute;
            right: -10px;
            top: -8px;
            color: #34495e;
            font-size: 16px;
        }
        .arrow-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #7f8c8d;
            white-space: nowrap;
            border: 1px solid #ecf0f1;
        }
        .note {
            background: #fff9e6;
            border-left: 4px solid #f39c12;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .sequence-num {
            background: #34495e;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        .sub-steps {
            margin-left: 50px;
            padding-left: 20px;
            border-left: 3px solid #ecf0f1;
        }
    </style>
</head>
<body>
    <h1>üîÑ Agent Registration and Request Flow</h1>

    <!-- REGISTRATION FLOW -->
    <div class="diagram-container">
        <h2>1Ô∏è‚É£ Agent Registration Flow (Startup)</h2>
        
        <div class="note">
            <strong>When:</strong> Agent container starts up<br>
            <strong>Purpose:</strong> Agent registers its capabilities with the framework
        </div>

        <div class="flow-diagram">
            <div class="flow-step">
                <div class="sequence-num">1</div>
                <div class="component agent">Beamline 5.3.1 Agent<br>Starts Up</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">Reads config.yml</div>
                </div>
                <div class="component agent">Loads Capabilities<br>["motor_control", "beam_alignment", "shutter_control"]</div>
            </div>

            <div class="flow-step">
                <div class="sequence-num">2</div>
                <div class="component agent">Beamline Agent</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">POST /register</div>
                </div>
                <div class="component registry">Agent Registry<br>(port 8100)</div>
            </div>

            <div class="sub-steps">
                <div class="code">
POST http://agent-registry:8100/register
{
  "name": "beamline_531_control",
  "url": "http://beamline-531-agent:8053",
  "capabilities": [
    "motor_control",
    "beam_alignment", 
    "shutter_control"
  ]
}
                </div>
            </div>

            <div class="flow-step">
                <div class="sequence-num">3</div>
                <div class="component registry">Agent Registry</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">Store mapping</div>
                </div>
                <div class="component registry">Capability Map<br>Updated</div>
            </div>

            <div class="sub-steps">
                <div class="code">
Registry Internal State:
{
  "agents": {
    "beamline_531_control": {
      "url": "http://beamline-531-agent:8053",
      "capabilities": [
        "motor_control",
        "beam_alignment",
        "shutter_control"
      ],
      "status": "active",
      "registered_at": "2025-10-10T14:30:00Z"
    }
  },
  "capability_map": {
    "motor_control": ["beamline_531_control"],
    "beam_alignment": ["beamline_531_control"],
    "shutter_control": ["beamline_531_control"]
  }
}
                </div>
            </div>

            <div class="flow-step">
                <div class="sequence-num">4</div>
                <div class="component registry">Agent Registry</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">200 OK</div>
                </div>
                <div class="component agent">Agent Ready<br>‚úÖ Registered</div>
            </div>
        </div>

        <div class="note">
            <strong>Result:</strong> Beamline 5.3.1 agent is now discoverable by the framework. When framework needs "motor_control", "beam_alignment", or "shutter_control" capabilities, registry knows to route to beamline_531_control agent.
        </div>
    </div>

    <!-- REQUEST FLOW -->
    <div class="diagram-container">
        <h2>2Ô∏è‚É£ Request Flow: "Move motor to 45 degrees"</h2>
        
        <div class="note">
            <strong>User Query:</strong> "Move motor M1 to 45 degrees"<br>
            <strong>Required Capability:</strong> motor_control
        </div>

        <div class="flow-diagram">
            <!-- Step 1: User Input -->
            <div class="flow-step">
                <div class="sequence-num">1</div>
                <div class="component user">User</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">Chat message</div>
                </div>
                <div class="component framework">Framework API<br>(Gateway)</div>
            </div>

            <div class="sub-steps">
                <div class="code">
POST http://framework-api:8000/chat
{
  "message": "Move motor M1 to 45 degrees",
  "session_id": "session-123"
}
                </div>
            </div>

            <!-- Step 2: Classification -->
            <div class="flow-step">
                <div class="sequence-num">2</div>
                <div class="component framework">Gateway</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">Invoke graph</div>
                </div>
                <div class="component orchestrator">LangGraph<br>Orchestrator</div>
            </div>

            <div class="flow-step">
                <div class="sequence-num">3</div>
                <div class="component orchestrator">Classifier Node</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">Analyze intent</div>
                </div>
                <div class="component orchestrator">LLM Analysis</div>
            </div>

            <div class="sub-steps">
                <div class="code">
Classification Result:
{
  "intent": "motor_control",
  "entities": {
    "motor_name": "M1",
    "target_position": 45,
    "unit": "degrees"
  },
  "required_capability": "motor_control"
}
                </div>
            </div>

            <!-- Step 3: Capability Lookup -->
            <div class="flow-step">
                <div class="sequence-num">4</div>
                <div class="component orchestrator">Router Node</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">Query: "motor_control"</div>
                </div>
                <div class="component registry">Agent Registry</div>
            </div>

            <div class="sub-steps">
                <div class="code">
GET http://agent-registry:8100/capability/motor_control

Response:
{
  "agents": [
    {
      "name": "motor_controller",
      "url": "http://motor-controller-agent:8052",
      "status": "active"
    }
  ]
}
                </div>
            </div>

            <!-- Step 4: Agent Invocation -->
            <div class="flow-step">
                <div class="sequence-num">5</div>
                <div class="component orchestrator">Capability Node</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">HTTP POST</div>
                </div>
                <div class="component agent">Motor Controller<br>Agent</div>
            </div>

            <div class="sub-steps">
                <div class="code">
POST http://motor-controller-agent:8052/capability/motor_control
{
  "parameters": {
    "motor_name": "M1",
    "target_position": 45,
    "unit": "degrees"
  },
  "context": {
    "user_id": "user-123",
    "session_id": "session-123",
    "approval_granted": true
  }
}
                </div>
            </div>

            <!-- Step 5: Agent Execution -->
            <div class="flow-step">
                <div class="sequence-num">6</div>
                <div class="component agent">Motor Agent</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">Execute capability</div>
                </div>
                <div class="component capability">motor_control()<br>handler</div>
            </div>

            <div class="sub-steps">
                <div class="code">
# Inside agent's capability handler
async def motor_control(parameters, context):
    motor_name = parameters['motor_name']
    position = parameters['target_position']
    
    # Connect to EPICS
    pv = f"MOTOR:{motor_name}:POSITION"
    
    # Move motor
    caput(pv, position)
    
    # Wait for completion
    while abs(caget(pv) - position) > 0.1:
        await asyncio.sleep(0.1)
    
    return {
        "success": True,
        "motor": motor_name,
        "final_position": caget(pv),
        "message": f"Motor {motor_name} moved to {position}¬∞"
    }
                </div>
            </div>

            <!-- Step 6: Response Back -->
            <div class="flow-step">
                <div class="sequence-num">7</div>
                <div class="component agent">Motor Agent</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">Return result</div>
                </div>
                <div class="component orchestrator">Capability Node</div>
            </div>

            <div class="sub-steps">
                <div class="code">
Response (200 OK):
{
  "success": true,
  "result": {
    "success": true,
    "motor": "M1",
    "final_position": 45.02,
    "message": "Motor M1 moved to 45¬∞"
  }
}
                </div>
            </div>

            <!-- Step 7: Response Processing -->
            <div class="flow-step">
                <div class="sequence-num">8</div>
                <div class="component orchestrator">Response Node</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">Format response</div>
                </div>
                <div class="component orchestrator">LLM Generation</div>
            </div>

            <div class="sub-steps">
                <div class="code">
LLM Prompt:
"User asked to move motor M1 to 45 degrees.
Result: Motor M1 moved to 45¬∞ (actual: 45.02¬∞)
Generate a natural language response."

LLM Output:
"I've successfully moved motor M1 to 45 degrees. 
The motor is now at position 45.02¬∞."
                </div>
            </div>

            <!-- Step 8: Final Response -->
            <div class="flow-step">
                <div class="sequence-num">9</div>
                <div class="component framework">Framework API</div>
                <div class="arrow">
                    <div class="arrow-line"></div>
                    <div class="arrow-label">Stream response</div>
                </div>
                <div class="component user">User</div>
            </div>

            <div class="sub-steps">
                <div class="code">
Response to User:
{
  "message": "I've successfully moved motor M1 to 45 degrees. 
              The motor is now at position 45.02¬∞.",
  "status": "completed",
  "execution_time": "2.3s"
}
                </div>
            </div>
        </div>

        <div class="note">
            <strong>Key Points:</strong>
            <ul>
                <li>‚úÖ Framework never imports agent code directly</li>
                <li>‚úÖ Communication is purely HTTP/REST</li>
                <li>‚úÖ Agents can be deployed independently</li>
                <li>‚úÖ Registry enables dynamic discovery</li>
                <li>‚úÖ LangGraph orchestrates the entire flow</li>
            </ul>
        </div>
    </div>

    <!-- SEQUENCE DIAGRAM STYLE -->
    <div class="diagram-container">
        <h2>3Ô∏è‚É£ Sequence Diagram View</h2>
        
        <svg width="100%" height="600" viewBox="0 0 900 600">
            <!-- Participants -->
            <text x="50" y="30" font-weight="bold">User</text>
            <text x="200" y="30" font-weight="bold">Framework</text>
            <text x="370" y="30" font-weight="bold">Registry</text>
            <text x="540" y="30" font-weight="bold">Agent</text>
            <text x="710" y="30" font-weight="bold">EPICS</text>
            
            <!-- Lifelines -->
            <line x1="80" y1="50" x2="80" y2="580" stroke="#ddd" stroke-width="2" stroke-dasharray="5,5"/>
            <line x1="250" y1="50" x2="250" y2="580" stroke="#ddd" stroke-width="2" stroke-dasharray="5,5"/>
            <line x1="420" y1="50" x2="420" y2="580" stroke="#ddd" stroke-width="2" stroke-dasharray="5,5"/>
            <line x1="590" y1="50" x2="590" y2="580" stroke="#ddd" stroke-width="2" stroke-dasharray="5,5"/>
            <line x1="760" y1="50" x2="760" y2="580" stroke="#ddd" stroke-width="2" stroke-dasharray="5,5"/>
            
            <!-- Messages -->
            <!-- 1. User request -->
            <line x1="80" y1="80" x2="250" y2="80" stroke="#3498db" stroke-width="2" marker-end="url(#arrowblue)"/>
            <text x="120" y="75" font-size="12" fill="#3498db">Move motor to 45¬∞</text>
            
            <!-- 2. Classify -->
            <rect x="230" y="100" width="40" height="60" fill="#f39c12" opacity="0.7"/>
            <text x="170" y="135" font-size="11">Classify intent</text>
            
            <!-- 3. Lookup capability -->
            <line x1="250" y1="180" x2="420" y2="180" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrowred)"/>
            <text x="280" y="175" font-size="12" fill="#e74c3c">Find "motor_control"</text>
            
            <!-- 4. Return agent URL -->
            <line x1="420" y1="210" x2="250" y2="210" stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowred)"/>
            <text x="280" y="225" font-size="12" fill="#e74c3c">agent URL</text>
            
            <!-- 5. Call agent -->
            <line x1="250" y1="250" x2="590" y2="250" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowgreen)"/>
            <text x="350" y="245" font-size="12" fill="#2ecc71">POST /capability/motor_control</text>
            
            <!-- 6. Agent execution -->
            <rect x="570" y="270" width="40" height="100" fill="#1abc9c" opacity="0.7"/>
            <text x="530" y="320" font-size="11">Execute</text>
            
            <!-- 7. EPICS write -->
            <line x1="590" y1="300" x2="760" y2="300" stroke="#9b59b6" stroke-width="2" marker-end="url(#arrowpurple)"/>
            <text x="630" y="295" font-size="12" fill="#9b59b6">caput(M1, 45)</text>
            
            <!-- 8. EPICS response -->
            <line x1="760" y1="330" x2="590" y2="330" stroke="#9b59b6" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowpurple)"/>
            <text x="640" y="345" font-size="12" fill="#9b59b6">OK</text>
            
            <!-- 9. Agent response -->
            <line x1="590" y1="390" x2="250" y2="390" stroke="#2ecc71" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowgreen)"/>
            <text x="350" y="385" font-size="12" fill="#2ecc71">Success result</text>
            
            <!-- 10. Format response -->
            <rect x="230" y="410" width="40" height="60" fill="#f39c12" opacity="0.7"/>
            <text x="165" y="445" font-size="11">Generate response</text>
            
            <!-- 11. Return to user -->
            <line x1="250" y1="490" x2="80" y2="490" stroke="#3498db" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowblue)"/>
            <text x="100" y="505" font-size="12" fill="#3498db">"Motor moved to 45¬∞"</text>
            
            <!-- Arrow markers -->
            <defs>
                <marker id="arrowblue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#3498db" />
                </marker>
                <marker id="arrowred" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#e74c3c" />
                </marker>
                <marker id="arrowgreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#2ecc71" />
                </marker>
                <marker id="arrowpurple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#9b59b6" />
                </marker>
            </defs>
        </svg>
    </div>

    <!-- KEY BENEFITS -->
    <div class="diagram-container">
        <h2>üéØ Key Benefits of This Architecture</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px;">
                <h3 style="color: #2ecc71; margin-top: 0;">‚úÖ Scalability</h3>
                <ul>
                    <li>Agents scale independently</li>
                    <li>Add new agents without framework changes</li>
                    <li>Multiple instances of same agent possible</li>
                </ul>
            </div>
            
            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px;">
                <h3 style="color: #3498db; margin-top: 0;">‚úÖ Flexibility</h3>
                <ul>
                    <li>Agents can be in any language</li>
                    <li>Deploy agents anywhere (different machines)</li>
                    <li>Update agents independently</li>
                </ul>
            </div>
            
            <div style="background: #fff3e0; padding: 20px; border-radius: 8px;">
                <h3 style="color: #f39c12; margin-top: 0;">‚úÖ Maintainability</h3>
                <ul>
                    <li>Clear separation of concerns</li>
                    <li>Each agent in its own repo</li>
                    <li>Independent versioning</li>
                </ul>
            </div>
            
            <div style="background: #f3e5f5; padding: 20px; border-radius: 8px;">
                <h3 style="color: #9b59b6; margin-top: 0;">‚úÖ Reliability</h3>
                <ul>
                    <li>Agent failures don't crash framework</li>
                    <li>Easy to restart individual agents</li>
                    <li>Health checks for monitoring</li>
                </ul>
            </div>
        </div>
    </div>

</body>
</html>